name: Swift Build & Test

on:
  push:
    branches: [ "main", "modernize/*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Swift ${{ matrix.swift }} on macOS ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, macos-15]
        swift: ['5.10']
        include:
          - os: macos-14
            xcode: '15.4'
          - os: macos-15
            xcode: 'latest'

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Select Xcode
      run: |
        if [ "${{ matrix.xcode }}" != "latest" ]; then
          sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode }}.app/Contents/Developer
        fi
        xcodebuild -version
        swift --version
      
    - name: Cache Swift Package Dependencies
      uses: actions/cache@v4
      with:
        path: |
          .build
          Package.resolved
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
      
    - name: Build Debug
      run: |
        swift build --configuration debug
      
    - name: Build Release
      run: |
        swift build --configuration release
        
    - name: Run Tests
      run: |
        if swift test 2>&1 | grep -q "no test"; then
          echo "⚠️  No tests defined yet - skipping"
          exit 0
        fi
      
    - name: Build All Apps (via Makefile)
      run: |
        make allapps || echo "Makefile build skipped"
      
    - name: Upload Build Artifacts
      if: matrix.os == 'macos-14' && matrix.swift == '5.10'
      uses: actions/upload-artifact@v4
      with:
        name: macpin-build-macos14
        path: |
          .build/release/
        retention-days: 7
