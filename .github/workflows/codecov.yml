name: Code Coverage

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  coverage:
    name: Generate Code Coverage
    runs-on: macos-14
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Select Xcode
      run: |
        sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
        xcodebuild -version
        swift --version
        
    - name: Cache Swift Package Dependencies
      uses: actions/cache@v4
      with:
        path: |
          .build
          Package.resolved
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
          
    - name: Build with Coverage
      run: |
        swift build --configuration debug
        
    - name: Run Tests with Coverage
      run: |
        # Run tests with code coverage enabled
        swift test --enable-code-coverage || echo "No tests yet - coverage will be empty"
        
    - name: Generate Coverage Report
      run: |
        # Find the coverage profdata
        PROFDATA=$(find .build -name "default.profdata" -type f 2>/dev/null | head -1)
        
        if [ -n "$PROFDATA" ]; then
          # Find the test binary
          TEST_BIN=$(find .build -name "*.xctest" -type d 2>/dev/null | head -1)
          
          if [ -n "$TEST_BIN" ]; then
            # Generate lcov format for Codecov
            xcrun llvm-cov export \
              -format=lcov \
              -instr-profile="$PROFDATA" \
              "$TEST_BIN/Contents/MacOS/"* \
              > coverage.lcov 2>/dev/null || echo "Coverage export failed"
          fi
        fi
        
        # Create empty coverage file if none exists (for repos without tests yet)
        if [ ! -f coverage.lcov ]; then
          echo "No coverage data - creating placeholder"
          touch coverage.lcov
        fi
        
    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: coverage.lcov
        flags: swift
        name: orbit-coverage
        fail_ci_if_error: false
        verbose: true
